name: Atualizar M√©tricas do README

on:
  schedule:
    # Roda todos os dias √† 0h UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Criar pasta de sa√≠da
        run: mkdir -p generated

      - name: Gera√ß√£o de Cart√£o de Estat√≠sticas (Commits e Linguagens)
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: gabrieltabosa
          filename: generated/metrics.md
          markdown: yes
          output_action: none
          template: classic
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year
          plugin_languages: yes
          plugin_languages_details: bytes-size, percentage
          plugin_languages_threshold: 0%
          plugin_languages_limit: 12

      - name: Montar README final com Tecnologias + M√©tricas + Frequ√™ncia de Commits
        run: |
          set -e

          # ----- CABE√áALHO / BIO / TECNOLOGIAS -----
          cat > generated/header.md <<'EOF'
# Gabriel Tabosa üëã

Desenvolvedor de software | Backend (.NET) & DevOps  
Atualmente trabalhando com APIs, automa√ß√£o e infraestrutura.

## üõ† Tecnologias que uso
- **Linguagens:** C#, F#, TypeScript, JavaScript (Node.js), Python, Java
- **Frontend:** React, Next.js, HTML, CSS, TailwindCSS, Blazor
- **Backend / Frameworks:** .NET (ASP.NET Core), Entity Framework, Spring Boot, Express
- **DevOps / Infra:** Docker, Kubernetes, GitHub Actions, Terraform, Azure, AWS, CI/CD
- **Banco de dados:** SQL Server, PostgreSQL, MySQL, Redis, MongoDB
- **Observability / Logs / Monitoring:** Prometheus, Grafana, ELK (Elasticsearch, Logstash, Kibana)
- **Outros:** Nginx, RabbitMQ, Kafka, gRPC, REST, OAuth2, Redis, Helm
EOF
          # ------------------------------------------

          # Se metrics.md n√£o existir ou estiver vazio, cria placeholder
          if [ ! -s generated/metrics.md ]; then
            echo "<!-- metrics not generated -->" > generated/metrics.md
            echo "" >> generated/metrics.md
            echo "_Nenhuma m√©trica foi gerada (ver workflow)._ " >> generated/metrics.md
          fi

          # ----- EXTRACAO HEURISTICA DE "COMMITS" -----
          # Tenta extrair um n√∫mero associado a "commit(s)" no generated/metrics.md
          # Procuramos por linhas contendo 'commit' (case-insensitive) e extra√≠mos o primeiro n√∫mero que aparecer na linha.
          COMMIT_COUNT_LINE=$(grep -iE 'commit' generated/metrics.md | head -n 1 || true)
          if [ -n "$COMMIT_COUNT_LINE" ]; then
            COMMIT_COUNT=$(echo "$COMMIT_COUNT_LINE" | grep -Eo '[0-9]+' | head -n1 || echo "0")
          else
            # fallback: tenta achar n√∫mero total de commits no arquivo (qualquer n√∫mero grande)
            COMMIT_COUNT=$(grep -Eo '[0-9]{1,6}' generated/metrics.md | head -n1 || echo "0")
          fi
          # Se ainda vazio, define 0
          if [ -z "$COMMIT_COUNT" ]; then
            COMMIT_COUNT=0
          fi

          # ----- CALCULA STATUS (HEUR√çSTICA) -----
          # Ajuste as faixas conforme preferir
          if [ "$COMMIT_COUNT" -ge 100 ]; then
            STATUS_EMOJI="üî•"
            STATUS_TEXT="Muito ativo"
          elif [ "$COMMIT_COUNT" -ge 30 ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="Ativo"
          elif [ "$COMMIT_COUNT" -ge 7 ]; then
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="Moderado"
          else
            STATUS_EMOJI="‚è≥"
            STATUS_TEXT="Pouco ativo"
          fi

          # ----- MONTA O BLOCO DE STATUS -----
          cat > generated/commit_status.md <<EOF
## üìà Frequ√™ncia de commits (heur√≠stica)

**Status:** ${STATUS_EMOJI} **${STATUS_TEXT}**  
**Commits (valor extra√≠do das m√©tricas):** **${COMMIT_COUNT}**

> Observa√ß√£o: o n√∫mero acima foi extra√≠do automaticamente do relat√≥rio de m√©tricas gerado pelo workflow. Dependendo do formato das m√©tricas, a extra√ß√£o √© heur√≠stica; se quiser um c√°lculo mais preciso (por exemplo, commits nos √∫ltimos 30 dias), posso ajustar o script para usar a API do GitHub com um token pessoal.
EOF

          # ----- MONTA O README FINAL -----
          {
            cat generated/header.md
            echo ""
            echo "---"
            echo ""
            cat generated/commit_status.md
            echo ""
            echo "---"
            echo ""
            cat generated/metrics.md
          } > README.md

          # Preview para logs
          echo "===== README gerado (preview) ====="
          sed -n '1,240p' README.md || true

      - name: Commit e push (se houver altera√ß√µes)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md generated/metrics.md generated/commit_status.md || true
          if git diff --cached --quiet; then
            echo "Sem altera√ß√µes para commitar"
          else
            git commit -m "chore: atualizar README com m√©tricas, tecnologias e status de commits"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

