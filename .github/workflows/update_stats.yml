name: Atualizar M√©tricas do README

on:
  schedule:
    # Roda todos os dias √† 0h UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Criar pasta de sa√≠da
        run: mkdir -p generated

      - name: Gera√ß√£o de Cart√£o de Estat√≠sticas (Commits e Linguagens)
        uses: lowlighter/metrics@latest
        with:
          # Use o GITHUB_TOKEN padr√£o do Actions (j√° dispon√≠vel)
          token: ${{ secrets.GITHUB_TOKEN }}
          user: gabrieltabosa
          # Gerar para ficheiro tempor√°rio para que possamos montar o README depois
          filename: generated/metrics.md
          markdown: yes
          output_action: none
          template: classic
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year
          plugin_languages: yes
          plugin_languages_details: bytes-size, percentage
          plugin_languages_threshold: 0%
          plugin_languages_limit: 8

      - name: Montar README final com Tecnologias + M√©tricas
        run: |
          set -e

          # --- Ajuste aqui a bio e as tecnologias que quer mostrar ---
          cat > generated/header.md <<'EOF'
# Gabriel Tabosa üëã

Desenvolvedor de software | Backend (.NET) & DevOps  
Atualmente trabalhando com APIs, automa√ß√£o e infraestrutura.

## üõ† Tecnologias
- **Linguagens:** C#, JavaScript, Python
- **Backend:** .NET, ASP.NET Core, Entity Framework
- **DevOps / Infra:** Docker, GitHub Actions, CI/CD, Azure
- **Banco de dados:** SQL Server, PostgreSQL
EOF
          # ----------------------------------------------------------

          # Verifica se o arquivo de m√©tricas foi gerado; se n√£o, cria um placeholder
          if [ ! -s generated/metrics.md ]; then
            echo "<!-- metrics not generated -->" > generated/metrics.md
            echo "" >> generated/metrics.md
            echo "_Nenhuma m√©trica foi gerada (ver workflow)._ " >> generated/metrics.md
          fi

          # Monta o README final: header + conte√∫do do metrics.md
          cat generated/header.md > README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          cat generated/metrics.md >> README.md

          # Mostrar preview (para logs)
          echo "===== README gerado ====="
          sed -n '1,200p' README.md || true

      - name: Commit e push (se houver altera√ß√µes)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md generated/metrics.md || true
          if git diff --cached --quiet; then
            echo "Sem altera√ß√µes para commitar"
          else
            git commit -m "chore: atualizar README com m√©tricas e tecnologias"
            git push
          fi
        env:
          # GITHUB_TOKEN √© injetado automaticamente
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
