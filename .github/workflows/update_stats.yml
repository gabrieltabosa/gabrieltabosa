name: Atualizar M√©tricas do README

on:
  schedule:
    - cron: "0 0 * * *" # Todos os dias √† 00h UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Criar pasta de sa√≠da
        run: mkdir -p generated

      - name: Gerar m√©tricas em Markdown puro
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: gabrieltabosa
          filename: generated/metrics.md
          markdown: yes           # Markdown puro
          output_action: none     # N√ÉO sobrescreve README diretamente
          template: classic
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year
          plugin_languages: yes
          plugin_languages_details: bytes-size, percentage
          plugin_languages_limit: 20
          plugin_languages_threshold: 0%
          plugin_topics: yes
          plugin_topics_limit: 0
          plugin_topics_mode: icons

      - name: Montar README final
        run: |
          set -e

          # ----- CABE√áALHO / BIO / TECNOLOGIAS -----
          cat > generated/header.md <<'EOF'
# Gabriel Tabosa üëã

Desenvolvedor apaixonado por backend e DevOps | APIs e boas pr√°ticas  

## üõ† Tecnologias que uso
- **Linguagens:** C#, F#, TypeScript, JavaScript (Node.js), Python, Java
- **Frontend:** React, Next.js, HTML, CSS, TailwindCSS, Blazor
- **Backend / Frameworks:** .NET (ASP.NET Core), Entity Framework, Spring Boot, Express
- **DevOps / Infra:** Docker, Kubernetes, GitHub Actions, Terraform, Azure, AWS, CI/CD
- **Banco de dados:** SQL Server, PostgreSQL, MySQL, Redis, MongoDB
- **Observability / Logs / Monitoring:** Prometheus, Grafana, ELK (Elasticsearch, Logstash, Kibana)
- **Outros:** Nginx, RabbitMQ, Kafka, gRPC, REST, OAuth2, Helm
EOF

          # Se metrics.md n√£o existir, cria placeholder
          if [ ! -s generated/metrics.md ]; then
            echo "<!-- metrics not generated -->" > generated/metrics.md
            echo "_Nenhuma m√©trica foi gerada (ver workflow)._ " >> generated/metrics.md
          fi

          # Monta README final
          {
            cat generated/header.md
            echo ""
            echo "---"
            echo ""
            cat generated/metrics.md
          } > README.md

      - name: Commit e push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md generated/metrics.md || true
          if git diff --cached --quiet; then
            echo "Sem altera√ß√µes para commitar"
          else
            git commit -m "chore: atualizar README com m√©tricas e tecnologias"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

